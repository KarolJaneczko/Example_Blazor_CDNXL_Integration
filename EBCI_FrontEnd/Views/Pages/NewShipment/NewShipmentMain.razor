@page "/new-shipment"
@using EBCI_FrontEnd.Services
@using EBCI_Library.Models
@using EBCI_Library.Services
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Web
@inject NavigationManager Navigation
@rendermode RenderMode.InteractiveServer

<PageTitle>New shipment form</PageTitle>

<div class="ns-card">
    <header class="ns-card-header">
        <h1 class="ns-title">Add new shipment to XL</h1>
        <p class="ns-subtitle">Fill the required fields and submit the shipment.</p>
    </header>

    <EditForm Model="NewShipment" OnValidSubmit="Submit_Button_Clicked" FormName="NewShipmentForm" class="ns-form">
        <DataAnnotationsValidator />
        <ValidationSummary class="ns-validation-summary" />

        <div class="ns-grid">
            <div class="ns-field">
                <label class="ns-label" for="supplier">
                    Supplier code
                </label>

                <div class="ns-input-group">
                    <InputText id="supplier"
                               class="ns-input"
                               @bind-Value="NewShipment.SupplierCode"
                               placeholder="e.g. BCB" />
                </div>
                <ValidationMessage For="@(() => NewShipment.SupplierCode)" class="ns-field-validation" />
            </div>

            <div class="ns-field">
                <label class="ns-label" for="shipmentDate">
                    Shipment date
                </label>
                <div class="ns-input-group">
                    <InputDate id="shipmentDate"
                               class="ns-input"
                               @bind-Value="NewShipment.ShipmentDate" />
                </div>
                <ValidationMessage For="@(() => NewShipment.ShipmentDate)" class="ns-field-validation" />
            </div>

            <div class="ns-field ns-full">
                <label class="ns-label" for="warehouse">
                    Warehouse code
                </label>
                <div class="ns-input-group">
                    <InputText id="warehouse"
                               class="ns-input"
                               @bind-Value="NewShipment.WarehouseCode"
                               placeholder="e.g. MAG" />
                </div>
                <ValidationMessage For="@(() => NewShipment.WarehouseCode)" class="ns-field-validation" />
            </div>

            <div>
                @foreach (var position in NewShipmentPositions) {
                    <div>@position.Lp</div>
                }
            </div>
        </div>

        <footer class="ns-actions">
            <button type="submit" class="ns-btn ns-btn-primary">Save shipment</button>
            <button type="button" class="ns-btn" @onclick="() => AddPosition_Button_Clicked()">Add position</button>
            <button type="button" class="ns-btn" @onclick="() => Cancel_Button_Clicked()">Cancel</button>
        </footer>

        @if (!string.IsNullOrEmpty(StatusMessage)) {
            <div class="ns-status @(IsSuccess ? "ns-success" : "ns-error")" role="status">
                @StatusMessage
            </div>
        }
    </EditForm>
</div>

@code {
    [SupplyParameterFromForm]
    private Shipment NewShipment { get; set; }

    [Inject]
    private ISignalService SignalService { get; set; }

    private List<ShipmentPosition> NewShipmentPositions = new List<ShipmentPosition>();
    private string StatusMessage { get; set; }
    private bool IsSuccess { get; set; }

    protected override void OnInitialized() {
        NewShipment ??= new() {
            SupplierCode = string.Empty,
            ShipmentDate = DateTime.Now,
            WarehouseCode = string.Empty,
            Positions = Array.Empty<ShipmentPosition>()
        };

        // TODO - Add getting list of warehouses
    }

    private async void Submit_Button_Clicked() {
        try {
            if (string.IsNullOrEmpty(NewShipment.SupplierCode)) {
                IsSuccess = false;
                StatusMessage = "Supplier code cannot be empty!";
                return;
            }

            if (string.IsNullOrEmpty(NewShipment.WarehouseCode)) {
                IsSuccess = false;
                StatusMessage = "Warehouse code cannot be empty!";
                return;
            }

            if (!(NewShipment.Positions?.Any() ?? false)) {

            }
            // TODO - Add validation for available suppliers and warehouse codes

            var result = await SignalService.TryToAddShipment(new NewShipmentRequest { Shipment = NewShipment });
            IsSuccess = result.IsSuccess;
            StatusMessage = result.ResponseMessage;
        } catch (Exception ex) {
            LogService.Error($"Exception occured at {nameof(Submit_Button_Clicked)}, message: {ex.Message}", ex);
            IsSuccess = false;
            StatusMessage = $"Exception occured: {ex.Message}, check logs at: {LogService.LogsPath}";
        }

        StateHasChanged();
    }

    private void AddPosition_Button_Clicked() {
        NewShipmentPositions.Add(new ShipmentPosition { Lp = NewShipmentPositions.Count + 1 });
    }

    private void Cancel_Button_Clicked() {
        Navigation.NavigateTo("/");
    }
}