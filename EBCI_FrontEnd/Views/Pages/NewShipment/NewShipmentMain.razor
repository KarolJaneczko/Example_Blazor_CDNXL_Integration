@page "/new-shipment"
@using EBCI_FrontEnd.Services
@using EBCI_Library.Models
@using EBCI_Library.Services
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Web
@inject NavigationManager Navigation
@rendermode RenderMode.InteractiveServer

<PageTitle>New shipment form</PageTitle>

<div class="ns-card">
    <header class="ns-card-header">
        <h1 class="ns-title">Add new shipment to XL</h1>
        <p class="ns-subtitle">Fill the required fields and submit the shipment.</p>
    </header>

    <EditForm Model="NewShipment" OnValidSubmit="Submit_Button_Clicked" FormName="NewShipmentForm" class="ns-form">
        <DataAnnotationsValidator />
        <ValidationSummary class="ns-validation-summary" />

        <div class="ns-grid">
            <div class="ns-field">
                <label class="ns-label" for="supplier">
                    Supplier code
                </label>

                <div class="ns-input-group">
                    <InputText id="supplier"
                               class="ns-input"
                               @bind-Value="NewShipment.SupplierCode"
                               placeholder="e.g. BCB" />
                </div>
                <ValidationMessage For="@(() => NewShipment.SupplierCode)" class="ns-field-validation" />
            </div>

            <div class="ns-field">
                <label class="ns-label" for="shipmentDate">
                    Shipment date
                </label>
                <div class="ns-input-group">
                    <InputDate id="shipmentDate"
                               class="ns-input"
                               @bind-Value="NewShipment.ShipmentDate" />
                </div>
                <ValidationMessage For="@(() => NewShipment.ShipmentDate)" class="ns-field-validation" />
            </div>

            <div class="ns-field ns-full">
                <label class="ns-label" for="warehouse">
                    Warehouse code
                </label>
                <div class="ns-input-group">
                    <InputText id="warehouse"
                               class="ns-input"
                               @bind-Value="NewShipment.WarehouseCode"
                               placeholder="e.g. MAG" />
                </div>
                <ValidationMessage For="@(() => NewShipment.WarehouseCode)" class="ns-field-validation" />
            </div>

            <div>
                @foreach (var position in NewShipmentPositions) {
                    <section class="ns-position-card" aria-label="Shipment position @position.Lp">
                        <div class="ns-position-header">
                            <div class="ns-position-meta">Nr: @position.Lp</div>

                            <div class="ns-position-actions">
                                <button type="button" class="ns-btn" @onclick="() => RemovePostition_Button_Clicked(position)">Remove</button>
                            </div>
                        </div>

                        <div class="ns-position-grid">
                            <div class="ns-field">
                                <label class="ns-label" for="productCode">
                                    Product code
                                </label>
                                <div class="ns-input-group">
                                    <InputText id="productCode"
                                               class="ns-input"
                                               @bind-Value="position.ProductCode" />
                                </div>
                            </div>

                            <div class="ns-field">
                                <label class="ns-label" for="quantity">
                                    Quantity
                                </label>
                                <div class="ns-input-group">
                                    <InputNumber id="quantity"
                                                 class="ns-input"
                                                 @bind-Value="position.Quantity" />
                                </div>
                            </div>

                            <div class="ns-field">
                                <label class="ns-label" for="batch">
                                    Batch
                                </label>
                                <div class="ns-input-group">
                                    <InputText id="batch"
                                               class="ns-input"
                                               @bind-Value="position.Batch" />
                                </div>
                            </div>

                            <div class="ns-field">
                                <label class="ns-label" for="expirationDate">
                                    Expiration date
                                </label>
                                <div class="ns-input-group">
                                    <InputDate id="expirationDate"
                                               class="ns-input"
                                               @bind-Value="position.ExpirationDate" />
                                </div>
                            </div>
                        </div>
                    </section>
                }
            </div>
        </div>

        <footer class="ns-actions">
            <button type="submit" class="ns-btn ns-btn-primary">Save shipment</button>
            <button type="button" class="ns-btn" @onclick="() => AddPosition_Button_Clicked()">Add position</button>
            <button type="button" class="ns-btn" @onclick="() => Cancel_Button_Clicked()">Cancel</button>
        </footer>

        @if (!string.IsNullOrEmpty(StatusMessage)) {
            <div class="ns-status @(IsSuccess ? "ns-success" : "ns-error")" role="status">
                @StatusMessage
            </div>
        }
    </EditForm>
</div>

@code {
    [SupplyParameterFromForm]
    private Shipment NewShipment { get; set; }

    [Inject]
    private ISignalService SignalService { get; set; }

    private readonly List<ShipmentPosition> NewShipmentPositions = new List<ShipmentPosition>();
    private HashSet<string> Suppliers, Warehouses, Products;
    private string StatusMessage { get; set; }
    private bool IsSuccess { get; set; }

    protected override async Task OnInitializedAsync() {
        NewShipment ??= new() {
            SupplierCode = string.Empty,
            ShipmentDate = DateTime.Now,
            WarehouseCode = string.Empty,
            Positions = Array.Empty<ShipmentPosition>()
        };

        var listsResponse = await SignalService.TryToSyncLists();
        Suppliers = new HashSet<string>(listsResponse.Suppliers);
        Warehouses = new HashSet<string>(listsResponse.Warehouses);
        Products = new HashSet<string>(listsResponse.Products);
        await base.OnInitializedAsync();
    }


    private async void Submit_Button_Clicked() {
        try {
            IsSuccess = true;
            StatusMessage = null;
            NewShipment.Positions = NewShipmentPositions;

            if (!NewShipment.Validate(out var message)) {
                StatusMessage = message;
                IsSuccess = false;
                return;
            }

            if (!Suppliers.Any(x => x.ToLower().Trim() == NewShipment.SupplierCode.ToLower().Trim())) {
                StatusMessage = $"There is no '{NewShipment.SupplierCode}' supplier registered in Comarch ERP XL configuration!";
                IsSuccess = false;
                return;
            }

            if (!Warehouses.Any(x => x.ToLower().Trim() == NewShipment.WarehouseCode.ToLower().Trim())) {
                StatusMessage = $"There is no '{NewShipment.WarehouseCode}' warehouse registered in Comarch ERP XL configuration!";
                IsSuccess = false;
                return;
            }

            foreach (var position in NewShipment.Positions) {
                var productCode = position.ProductCode;

                if (!Products.Any(x => x.ToLower().Trim() == productCode.ToLower().Trim())) {
                    StatusMessage = $"There is no '{productCode}' (LP: {position.Lp}) product registered in Comarch ERP XL configuration!";
                    IsSuccess = false;
                    return;
                }
            }

            // todo loading indicator
            var result = await SignalService.TryToAddShipment(new NewShipmentRequest { Shipment = NewShipment });
            IsSuccess = result.IsSuccess;
            StatusMessage = result.ResponseMessage;
        } catch (Exception ex) {
            LogService.Error($"Exception occured at {nameof(Submit_Button_Clicked)}, message: {ex.Message}", ex);
            IsSuccess = false;
            StatusMessage = $"Exception occured: {ex.Message}, check logs at: {LogService.LogsPath}";
        }

        StateHasChanged();
    }

    private void AddPosition_Button_Clicked() {
        NewShipmentPositions.Add(new ShipmentPosition {
            Lp = NewShipmentPositions.Count + 1,
            ExpirationDate = DateTime.Now.Date
        });
    }

    private void RemovePostition_Button_Clicked(ShipmentPosition shipmentPosition) {
        NewShipmentPositions.Remove(shipmentPosition);

        var i = 1;
        foreach (var newShipmentPosition in NewShipmentPositions) {
            newShipmentPosition.Lp = i++;
        }

        StateHasChanged();
    }

    private void Cancel_Button_Clicked() {
        Navigation.NavigateTo("/");
    }
}